@using VConnect.Models.Events
@using VConnect.Models.Enums
@model IEnumerable<Event>

@{
    ViewData["Title"] = "Volunteer Activities - VConnect";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Read current filters from ViewBag (set them in controller)
    string search = ViewBag.Search as string ?? "";
    string category = ViewBag.Category as string ?? "";
    string statusSel = ViewBag.Status as string ?? "";
    string monthSel = ViewBag.Month as string ?? "";

    // Helper to mark <option selected>
    string Sel(string v, string current) =>
        string.Equals(v ?? "", current ?? "", StringComparison.OrdinalIgnoreCase) ? "selected" : null;

    // Categories shown in the dropdown (adjust to your domain)
    var categories = new[] { "Health", "Education", "Environment", "Community", "Fundraising", "Logistics", "Other" };

    // Months filter (value = "YYYY-MM" that your controller can parse)
    var months = Enumerable.Range(0, 6)
        .Select(i => DateTime.UtcNow.AddMonths(-i))
        .OrderByDescending(d => d)
        .Select(d => new { Value = d.ToString("yyyy-MM"), Label = d.ToString("MMMM yyyy") })
        .ToList();
}

<!-- HERO SECTION -->
<section class="hero-section">
    <div class="container text-center text-white">
        <h1 class="hero-title">Find a Social-Impact Event</h1>
        <p class="hero-subtitle">Search, filter, and apply to volunteer opportunities</p>
    </div>
</section>

<!-- FILTERS -->
<section class="py-4 bg-light">
    <div class="container">
        <div class="case-card card border-0 shadow-sm p-3 p-md-4">
            <form method="get" asp-action="Index" asp-controller="Events" class="row g-3 align-items-end">
                <div class="col-lg-4">
                    <label class="form-label fw-semibold">Search</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light"><i class="fas fa-search"></i></span>
                        <input type="text" name="search" value="@search" class="form-control" placeholder="Search title, location..." />
                    </div>
                </div>

                <div class="col-6 col-lg-3">
                    <label class="form-label fw-semibold">Category</label>
                    <select class="form-select" name="category">
                        <option value="">All Categories</option>
                        @foreach (var c in categories)
                        {
                            <option value="@c" selected="@Sel(c, category)">@c</option>
                        }
                    </select>
                </div>

                <div class="col-6 col-lg-3">
                    <label class="form-label fw-semibold">Status</label>
                    <select class="form-select" name="status">
                        <option value="">Any Status</option>
                        <option value="@EventStatus.Active" selected="@Sel(nameof(EventStatus.Active), statusSel)">Active</option>
                        <option value="@EventStatus.Completed" selected="@Sel(nameof(EventStatus.Completed), statusSel)">Completed</option>
                        <option value="@EventStatus.Cancelled" selected="@Sel(nameof(EventStatus.Cancelled), statusSel)">Cancelled</option>
                    </select>
                </div>

                <div class="col-6 col-lg-2">
                    <label class="form-label fw-semibold">Month</label>
                    <select class="form-select" name="month">
                        <option value="">This Month</option>
                        @foreach (var m in months)
                        {
                            <option value="@m.Value" selected="@Sel(m.Value, monthSel)">@m.Label</option>
                        }
                    </select>
                </div>

                <div class="col-12 d-flex gap-2 justify-content-end mt-3">
                    <a asp-action="Index" asp-controller="Events" class="btn btn-outline-secondary case-button">
                        <i class="fas fa-rotate-left me-1"></i> Reset
                    </a>
                    <button class="btn btn-primary case-button" type="submit">
                        <i class="fas fa-filter me-1"></i> Apply Filters
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>

<!-- RESULTS -->
<section class="py-5">
    <div class="container">
        @if (Model == null || !Model.Any())
        {
            <div class="alert alert-light border text-center">
                <i class="far fa-calendar-xmark me-1"></i> No events match your filters.
            </div>
        }
        else
        {
            <div class="text-center section-heading mb-5">
                <h2 class="section-title">Available Volunteer Opportunities</h2>
                <p class="section-subtitle">Join our community events and make a difference</p>
            </div>

            <div class="row g-4">
                @foreach (var e in Model)
                {
                    var filled = (e.Participations?.Count() ?? 0);
                    var cap = Math.Max(0, e.Capacity);
                    var pct = cap > 0 ? Math.Clamp((int)Math.Round(100.0 * filled / cap), 0, 100) : 0;

                    <div class="col-md-6 col-xl-4">
                        <div class="case-card card border-0 shadow-sm h-100">
                            <!-- Image (optional image URL property could be added to Event) -->
                            <div class="case-image-container">
                                <img class="case-image w-100" src="@(string.IsNullOrWhiteSpace(e.Description) ? Url.Content("~/images/volunteer-placeholder.jpg") : Url.Content("~/images/volunteer-placeholder.jpg"))" alt="@e.Title" />
                                
                            </div>

                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="badge location-badge">
                                        <i class="fas fa-location-dot me-1"></i>@(e.Location ?? "TBA")
                                    </span>
                                    <span class="badge @(e.Status == EventStatus.Active ? "bg-success" : e.Status == EventStatus.Completed ? "bg-secondary" : "bg-danger")">
                                        @e.Status
                                    </span>
                                </div>

                                <h5 class="card-title case-title mb-2">@e.Title</h5>
                                <div class="text-muted small mb-2">
                                    <i class="far fa-clock me-1"></i>
                                    @e.StartDateTime.ToString("MMM d, yyyy — h:mm tt")
                                </div>
                                <p class="mb-3 small text-secondary">
                                    @((e.Description ?? "").Length > 120 ? (e.Description.Substring(0, 120) + "...") : e.Description)
                                </p>

                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div class="small text-secondary">
                                        <i class="fas fa-users me-1"></i>@filled / @cap
                                    </div>
                                    <div class="small fw-semibold">
                                        @(string.IsNullOrWhiteSpace(e.Compensation) ? "Free" : e.Compensation)
                                    </div>
                                </div>
                                <div class="capacity-bar mb-3">
                                    <div class="capacity-fill" style="width:@pct%"></div>
                                </div>

                                <div class="d-flex gap-2">
                                    <a asp-action="Details" asp-route-id="@e.EventId" class="btn btn-outline-secondary w-50 case-button">
                                        Details
                                    </a>

                                    @if (e.Status == EventStatus.Active && filled < cap)
                                    {
                                        <form asp-action="Apply" asp-controller="Events" method="post" class="w-50">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="eventId" value="@e.EventId" />
                                            <button type="submit" class="btn btn-primary w-100 case-button">
                                                Apply Now
                                            </button>
                                        </form>
                                    }
                                    else
                                    {
                                        <button class="btn btn-secondary w-50 case-button" disabled>
                                            @((e.Status != EventStatus.Active) ? "Closed" : "Full")
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Simple pager placeholder (hook to your paging) -->
            <div class="d-flex justify-content-between align-items-center mt-5">
                <div class="text-muted small">Showing @Model.Count() item(s)</div>
                <nav aria-label="Event page navigation">
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item disabled"><span class="page-link">«</span></li>
                        <li class="page-item active"><span class="page-link">1</span></li>
                        <li class="page-item disabled"><span class="page-link">»</span></li>
                    </ul>
                </nav>
            </div>
        }
    </div>
</section>

<!-- Call to Action -->
<section class="cta-section">
    <div class="container text-center text-white">
        <h2 class="cta-title mb-3">Can't Find the Right Opportunity?</h2>
        <p class="cta-subtitle mb-4">Create your own event and invite volunteers to join your cause</p>
        <div class="cta-buttons">
            <a href="@Url.Action("Create", "Events")" class="btn btn-warning btn-lg px-4 me-3">
                <i class="fas fa-plus me-2"></i>Create Event
            </a>
            <a href="@Url.Action("Index", "Home")" class="btn btn-outline-light btn-lg px-4">
                <i class="fas fa-home me-2"></i>Back to Home
            </a>
        </div>
    </div>
</section>

@section Styles {
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0b3d2e;
            --secondary-color: #1a5e48;
            --accent-color: #ffc107;
            --light-bg: #f8f9fa;
            --dark-text: #232a36;
        }

        /* Hero Section */
        .hero-section {
            padding: 7rem 0 5rem;
            background: linear-gradient(135deg, var(--dark-text) 0%, var(--secondary-color) 100%);
            margin-top: -25px;
            position: relative;
            overflow: hidden;
        }

        .hero-title {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            animation: fadeInDown 1s ease;
        }

        .hero-subtitle {
            font-size: 1.35rem;
            max-width: 700px;
            margin: 0 auto;
            animation: fadeInUp 1s ease;
        }

        /* Section Headings */
        .section-heading {
            margin-bottom: 3rem;
        }

        .section-title {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .section-subtitle {
            font-size: 1.25rem;
            color: #6c757d;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Case Cards */
        .case-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-radius: 15px;
            overflow: hidden;
        }

        .case-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1) !important;
        }

        .case-image-container {
            position: relative;
            height: 220px;
            overflow: hidden;
        }

        .case-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .case-card:hover .case-image {
            transform: scale(1.1);
        }

        .case-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .case-card:hover .case-overlay {
            opacity: 1;
        }

        .case-title {
            color: var(--primary-color);
            font-weight: 700;
            transition: color 0.3s ease;
        }

        .case-card:hover .case-title {
            color: var(--secondary-color);
        }

        .case-button {
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 50px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .case-button:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* Badges */
        .category-badge {
            background-color: var(--primary-color);
            color: white;
        }

        .location-badge {
            background-color: #6c757d;
            color: white;
        }

        /* Capacity Bar */
        .capacity-bar {
            height: 6px;
            background: #f1f5f9;
            border-radius: 999px;
            overflow: hidden;
        }

        .capacity-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.5s ease;
        }

        /* CTA Section */
        .cta-section {
            padding: 5rem 0;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            position: relative;
            overflow: hidden;
        }

        .cta-title {
            font-weight: 700;
            font-size: 2.5rem;
        }

        .cta-subtitle {
            font-size: 1.3rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .cta-buttons .btn {
            border-radius: 50px;
            padding: 0.8rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .cta-buttons .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }

        /* Animations */
        @@keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @@keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Design */
        @@media (max-width: 1200px) {
            .hero-title {
                font-size: 3rem;
            }
        }

        @@media (max-width: 992px) {
            .hero-section {
                padding: 6rem 0 4rem;
            }

            .hero-title {
                font-size: 2.5rem;
            }

            .hero-subtitle {
                font-size: 1.2rem;
            }
        }

        @@media (max-width: 768px) {
            .hero-title {
                font-size: 2.2rem;
            }

            .hero-subtitle {
                font-size: 1.1rem;
            }

            .cta-title {
                font-size: 2rem;
            }

            .cta-subtitle {
                font-size: 1.1rem;
            }

            .cta-buttons .btn {
                display: block;
                width: 100%;
                margin-bottom: 1rem;
            }

            .cta-buttons .btn:last-child {
                margin-bottom: 0;
            }
        }

        @@media (max-width: 576px) {
            .hero-title {
                font-size: 2rem;
            }

            .section-title {
                font-size: 1.8rem;
            }
        }
    </style>
}